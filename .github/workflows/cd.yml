name: CD Pipeline

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types:
      - completed
    branches:
      - main
  workflow_dispatch:

jobs:
  check-ci-status:
    name: Check CI Status
    runs-on: ubuntu-22.04
    if: >-
      github.event_name == 'workflow_dispatch' || 
      github.event.workflow_run.conclusion == 'success'
    steps:
      - name: Get workflow details
        if: github.event_name == 'workflow_run'
        run: |
          echo "CI íŒŒì´í”„ë¼ì¸ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."
          echo "ì›Œí¬í”Œë¡œìš° ID: ${{ github.event.workflow_run.id }}"
          echo "ì›Œí¬í”Œë¡œìš° ì´ë¦„: ${{ github.event.workflow_run.name }}"
          echo "ë¸Œëœì¹˜: ${{ github.event.workflow_run.head_branch }}"

      - name: Manual trigger info
        if: github.event_name == 'workflow_dispatch'
        run: echo "CD íŒŒì´í”„ë¼ì¸ì´ ìˆ˜ë™ìœ¼ë¡œ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤."

  build-and-push-backend:
    name: Build and Push Backend Docker Image
    runs-on: ubuntu-22.04
    needs: check-ci-status
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1 # ìµœì í™”: ë¶ˆí•„ìš”í•œ Git íˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ì§€ ì•ŠìŒ

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push backend image
        uses: docker/build-push-action@v5
        with:
          context: ./
          file: ./apps/backend/Dockerfile
          cache-from: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/cirrodrive:backend-cache
          cache-to: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/cirrodrive:backend-cache,mode=max
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/cirrodrive:backend

  build-and-push-frontend:
    name: Build and Push Frontend Docker Image
    runs-on: ubuntu-22.04
    needs: check-ci-status
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1 # ìµœì í™”: ë¶ˆí•„ìš”í•œ Git íˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ì§€ ì•ŠìŒ

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./
          file: ./apps/frontend/Dockerfile
          cache-from: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/cirrodrive:frontend-cache
          cache-to: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/cirrodrive:frontend-cache,mode=max
          secrets: |
            VITE_API_HOST=${{ secrets.APP_PUBLIC_HOST }}
            VITE_API_PORT=8000
            VITE_TOSS_CLIENT_KEY=test_ck_d46qopOB892JAe2jwoQY3ZmM75y0
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/cirrodrive:frontend

  build-and-push-reverse-proxy:
    name: Build and Push Reverse Proxy Docker Image
    runs-on: ubuntu-22.04
    needs: check-ci-status
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1 # ìµœì í™”: ë¶ˆí•„ìš”í•œ Git íˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ì§€ ì•ŠìŒ

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Build and push reverse-proxy image
        uses: docker/build-push-action@v5
        with:
          context: ./apps/reverse-proxy
          file: ./apps/reverse-proxy/Dockerfile
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/cirrodrive:reverse-proxy

  database-migration:
    name: database-migration
    runs-on: ubuntu-22.04
    needs: check-ci-status
    environment: production
    env:
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      AUTH_DEFAULT_ADMIN_EMAIL: ${{ secrets.AUTH_DEFAULT_ADMIN_EMAIL }}
      AUTH_DEFAULT_ADMIN_PASSWORD: ${{ secrets.AUTH_DEFAULT_ADMIN_PASSWORD }}
      AUTH_DEFAULT_ADMIN_USERNAME: ${{ secrets.AUTH_DEFAULT_ADMIN_USERNAME }}
    steps:
      - name: Prepare Docker Environment
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          envs: DATABASE_URL,AUTH_DEFAULT_ADMIN_EMAIL,AUTH_DEFAULT_ADMIN_PASSWORD,AUTH_DEFAULT_ADMIN_USERNAME
          script: |
            # ë°°í¬ ë””ë ‰í† ë¦¬ í™•ì¸ ë° ìƒì„±
            mkdir -p /home/${{ secrets.SERVER_USER }}/cirrodrive-deploy

            cd /home/${{ secrets.SERVER_USER }}/cirrodrive-deploy

            # í˜„ì¬ ë¸Œëœì¹˜ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            git fetch origin

            # í˜„ì¬ ì›Œí¬í”Œë¡œìš°ê°€ ì‹¤í–‰ëœ ë¸Œëœì¹˜ë¡œ ì²´í¬ì•„ì›ƒ
            CURRENT_BRANCH="${{ github.ref_name }}"
            echo "í˜„ì¬ ë¸Œëœì¹˜ë¡œ ì²´í¬ì•„ì›ƒ: $CURRENT_BRANCH"

            # ë¸Œëœì¹˜ ì²´í¬ì•„ì›ƒ (ë¡œì»¬ ë¸Œëœì¹˜ê°€ ì—†ìœ¼ë©´ ìƒì„±)
            git checkout -B $CURRENT_BRANCH origin/$CURRENT_BRANCH || {
              echo "ë¸Œëœì¹˜ ì²´í¬ì•„ì›ƒ ì‹¤íŒ¨, ê¸°ë³¸ ë¸Œëœì¹˜ë¡œ fallback"
              git checkout main
            }

            pnpm install
            pnpm run db:push
            pnpm run db:seed

  prepare-release:
    name: Prepare Release
    runs-on: ubuntu-22.04
    needs:
      [
        build-and-push-backend,
        build-and-push-frontend,
        build-and-push-reverse-proxy,
      ]
    environment: production
    steps:
      - name: Prepare Docker Environment
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            # Docker ì´ë¯¸ì§€ ìµœì‹  ë²„ì „ ê°€ì ¸ì˜¤ê¸°

            echo "Docker ì´ë¯¸ì§€ pull ì‹œì‘..."

            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬
            docker container prune -f || true

            # ë„¤íŠ¸ì›Œí¬ ì •ë¦¬
            docker network prune -f || true

            # ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ë³¼ë¥¨ ì •ë¦¬
            docker volume prune -f || true

            # ê°œë³„ ì´ë¯¸ì§€ pull
            pull_image_with_retry() {
              local image_name=$1
              local max_retries=3
              local retry_count=0
              
              while [ $retry_count -lt $max_retries ]; do
                echo "ì´ë¯¸ì§€ pull ì‹œë„ ($((retry_count + 1))/$max_retries): $image_name"
                
                if docker pull "$image_name"; then
                  echo "âœ… ì„±ê³µì ìœ¼ë¡œ ì´ë¯¸ì§€ë¥¼ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤: $image_name"
                  return 0
                else
                  echo "âŒ ì´ë¯¸ì§€ pull ì‹¤íŒ¨: $image_name"
                  retry_count=$((retry_count + 1))
                  
                  if [ $retry_count -lt $max_retries ]; then
                    echo "ë””ìŠ¤í¬ ê³µê°„ ì •ë¦¬ í›„ ì¬ì‹œë„..."
                    # ëŒ•ê¸€ë§ ì´ë¯¸ì§€ë§Œ ì‚­ì œ
                    docker image prune -f || true
                    sleep 5
                  fi
                fi
              done
              
              echo "âŒ ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼: $image_name"
              return 1
            }

            # ê° ì´ë¯¸ì§€ pull
            pull_image_with_retry "${{ secrets.DOCKERHUB_USERNAME }}/cirrodrive:backend" || { 
              echo "ë°±ì—”ë“œ ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸° ìµœì¢… ì‹¤íŒ¨"; exit 1; 
            }

            pull_image_with_retry "${{ secrets.DOCKERHUB_USERNAME }}/cirrodrive:frontend" || { 
              echo "í”„ë¡ íŠ¸ì—”ë“œ ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸° ìµœì¢… ì‹¤íŒ¨"; exit 1; 
            }

            pull_image_with_retry "${{ secrets.DOCKERHUB_USERNAME }}/cirrodrive:reverse-proxy" || { 
              echo "ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸° ìµœì¢… ì‹¤íŒ¨"; exit 1; 
            }

            echo "âœ… ëª¨ë“  Docker ì´ë¯¸ì§€ê°€ ì„±ê³µì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤"

            # ìµœì¢… ì´ë¯¸ì§€ í™•ì¸
            echo "í˜„ì¬ ì‚¬ìš© ê°€ëŠ¥í•œ cirrodrive ì´ë¯¸ì§€:"
            docker images | grep cirrodrive || echo "cirrodrive ì´ë¯¸ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"

  deployment:
    name: Deployment
    runs-on: ubuntu-22.04
    needs: [prepare-release, database-migration]
    environment: production
    env:
      NODE_ENV: production
      APP_PUBLIC_HOST: ${{ secrets.APP_PUBLIC_HOST }}
      APP_BACKEND_PORT: 8000
      APP_FRONTEND_PORT: 3000
      AUTH_JWT_SECRET: ${{ secrets.AUTH_JWT_SECRET }}
      AUTH_DEFAULT_ADMIN_USERNAME: ${{ secrets.AUTH_DEFAULT_ADMIN_USERNAME }}
      AUTH_DEFAULT_ADMIN_PASSWORD: ${{ secrets.AUTH_DEFAULT_ADMIN_PASSWORD }}
      AWS_REGION: ap-northeast-2
      AWS_SES_SOURCE_EMAIL: ${{ secrets.AWS_SES_SOURCE_EMAIL }}
      AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
      AWS_CLOUDFRONT_DOMAIN: ${{ secrets.AWS_CLOUDFRONT_DOMAIN }}
      AWS_CLOUDFRONT_KEY_PAIR_ID: ${{ secrets.AWS_CLOUDFRONT_KEY_PAIR_ID }}
      AWS_CLOUDFRONT_PRIVATE_KEY: ${{ secrets.AWS_CLOUDFRONT_PRIVATE_KEY }}
      AWS_CLOUDFRONT_EXPIRES_IN_SECONDS: 3600
      PAYMENT_TOSS_SECRET_KEY: ${{ secrets.PAYMENT_TOSS_SECRET_KEY }}
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
    steps:
      - name: Deploy and Start Containers
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          envs: NODE_ENV,APP_BACKEND_PORT,APP_FRONTEND_PORT,APP_PUBLIC_HOST,AUTH_JWT_SECRET,AUTH_DEFAULT_ADMIN_USERNAME,AUTH_DEFAULT_ADMIN_PASSWORD,AWS_REGION,AWS_SES_SOURCE_EMAIL,AWS_S3_BUCKET,AWS_CLOUDFRONT_DOMAIN,AWS_CLOUDFRONT_KEY_PAIR_ID,AWS_CLOUDFRONT_PRIVATE_KEY,AWS_CLOUDFRONT_EXPIRES_IN_SECONDS,PAYMENT_TOSS_SECRET_KEY,DATABASE_URL
          script: |
            # ì‘ì—… ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd /home/${{ secrets.SERVER_USER }}/cirrodrive-deploy

            # Docker ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘
            pnpm run docker:down
            pnpm run docker:up || { echo "Docker ì»¨í…Œì´ë„ˆ ì‹œì‘ ì‹¤íŒ¨"; exit 1; }

  validate-deployment:
    name: Validate Deployment
    runs-on: ubuntu-22.04
    needs: deployment
    environment: production
    steps:
      - name: Wait for containers to initialize
        run: sleep 20

      - name: Check Container Health Status
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            echo "ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸ ì¤‘..."

            # ë°±ì—”ë“œ ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
            BACKEND_HEALTH=$(docker inspect --format='{{.State.Health.Status}}' cirrodrive-backend)
            echo "ë°±ì—”ë“œ ì»¨í…Œì´ë„ˆ ìƒíƒœ: $BACKEND_HEALTH"

            # í”„ë¡ íŠ¸ì—”ë“œ ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
            FRONTEND_HEALTH=$(docker inspect --format='{{.State.Health.Status}}' cirrodrive-frontend)
            echo "í”„ë¡ íŠ¸ì—”ë“œ ì»¨í…Œì´ë„ˆ ìƒíƒœ: $FRONTEND_HEALTH"

            # ìƒíƒœ ê²€ì¦
            if [ "$BACKEND_HEALTH" != "healthy" ] || [ "$FRONTEND_HEALTH" != "healthy" ]; then
              echo "ì»¨í…Œì´ë„ˆê°€ ì •ìƒ ìƒíƒœê°€ ì•„ë‹™ë‹ˆë‹¤!"
              
              if [ "$BACKEND_HEALTH" != "healthy" ]; then
                echo "ë°±ì—”ë“œ ì»¨í…Œì´ë„ˆ ë¡œê·¸:"
                docker logs cirrodrive-backend --tail 100
              fi
              
              if [ "$FRONTEND_HEALTH" != "healthy" ]; then
                echo "í”„ë¡ íŠ¸ì—”ë“œ ì»¨í…Œì´ë„ˆ ë¡œê·¸:"
                docker logs cirrodrive-frontend --tail 100
              fi
              
              exit 1
            fi

            echo "ëª¨ë“  ì»¨í…Œì´ë„ˆê°€ ì •ìƒ ìƒíƒœì…ë‹ˆë‹¤!"

            # ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ ë¡œê·¸ í™•ì¸
            docker ps -a | grep cirrodrive

  notify-success:
    name: Notify Success
    runs-on: ubuntu-22.04
    needs: validate-deployment
    env:
      APP_PUBLIC_HOST: cirrodrive.kro.kr
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Get commit info
        id: commit-info
        run: |
          echo "commit_sha=$(git log -1 --pretty=%h)" >> $GITHUB_OUTPUT

      - name: Get deployment details
        id: deployment-details
        run: |
          # í˜„ì¬ ì‹œê°„ (KST)
          NOW=$(TZ=Asia/Seoul date +"%Y-%m-%d %H:%M:%S %Z")
          echo "deployment_time=$NOW" >> $GITHUB_OUTPUT
          echo "workflow_url=https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_OUTPUT

      - name: Notify Discord Success
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          status: success
          title: "ğŸš€ ë°°í¬ ì„±ê³µ"
          description: |
            **í™˜ê²½:** Production
            **ë°°í¬ ì‹œê°„:** ${{ steps.deployment-details.outputs.deployment_time }}
            **URL:** http://${{ env.APP_PUBLIC_HOST }}
            **ì»¤ë°‹:** [${{ steps.commit-info.outputs.commit_sha }}](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})
          color: 3066993
          url: ${{ steps.deployment-details.outputs.workflow_url }}
          username: GitHub Actions
          avatar_url: https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png

  notify-failure:
    name: Notify Failure
    runs-on: ubuntu-22.04
    needs: validate-deployment
    if: failure()
    env:
      APP_PUBLIC_HOST: cirrodrive.kro.kr
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Get commit info
        id: commit-info
        run: |
          echo "commit_sha=$(git log -1 --pretty=%h)" >> $GITHUB_OUTPUT

      - name: Get deployment details
        id: deployment-details
        run: |
          # í˜„ì¬ ì‹œê°„ (KST)
          NOW=$(TZ=Asia/Seoul date +"%Y-%m-%d %H:%M:%S %Z")
          echo "deployment_time=$NOW" >> $GITHUB_OUTPUT
          echo "workflow_url=https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_OUTPUT

      - name: Notify Discord Failure
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          status: failure
          content: "@here ë°°í¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤! ê¸´ê¸‰ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤."
          title: "âŒ ë°°í¬ ì‹¤íŒ¨"
          description: |
            **í™˜ê²½:** Production
            **ë°°í¬ ì‹œê°„:** ${{ steps.deployment-details.outputs.deployment_time }}
            **URL:** http://${{ env.APP_PUBLIC_HOST }}
            **ì»¤ë°‹:** [${{ steps.commit-info.outputs.commit_sha }}](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})
          color: 15158332
          url: ${{ steps.deployment-details.outputs.workflow_url }}
          username: GitHub Actions
          avatar_url: https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png
