name: CD Pipeline

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types:
      - completed
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-push:
    name: Build and Push Docker Images
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1 # ìµœì í™”: ë¶ˆí•„ìš”í•œ Git íˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ì§€ ì•ŠìŒ

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push backend image
        uses: docker/build-push-action@v5
        with:
          context: ./
          file: ./apps/backend/Dockerfile
          cache-from: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/cirrodrive:backend-cache
          cache-to: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/cirrodrive:backend-cache,mode=max
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/cirrodrive:backend

      - name: Build and push frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./
          file: ./apps/frontend/Dockerfile
          cache-from: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/cirrodrive:frontend-cache
          cache-to: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/cirrodrive:frontend-cache,mode=max
          secrets: |
            VITE_API_HOST=cirrodrive.kro.kr
            VITE_API_PORT=8000
            VITE_TOSS_CLIENT_KEY=test_ck_d46qopOB892JAe2jwoQY3ZmM75y0
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/cirrodrive:frontend

  database-migration:
    name: database-migration
    runs-on: ubuntu-22.04
    needs: build-and-push
    environment: production
    env:
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
    steps:
      - name: Prepare Docker Environment
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          envs: DATABASE_URL
          script: |
            # ë°°í¬ ë””ë ‰í† ë¦¬ í™•ì¸ ë° ìƒì„±
            mkdir -p /home/${{ secrets.SERVER_USER }}/cirrodrive-deploy

            cd /home/${{ secrets.SERVER_USER }}/cirrodrive-deploy
            git pull
            pnpm install
            pnpm run db:push
            pnpm run db:seed

  prepare-release:
    name: Prepare Release
    runs-on: ubuntu-22.04
    needs: database-migration
    environment: production
    steps:
      - name: Prepare Docker Environment
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            # Docker ì´ë¯¸ì§€ ìµœì‹  ë²„ì „ ê°€ì ¸ì˜¤ê¸°

            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/cirrodrive:backend || {
              docker system prune -a -f &&
              docker pull ${{ secrets.DOCKERHUB_USERNAME }}/cirrodrive:backend
            } || { echo "ë°±ì—”ë“œ ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨"; exit 1; }

            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/cirrodrive:frontend || {
              docker system prune -a -f &&
              docker pull ${{ secrets.DOCKERHUB_USERNAME }}/cirrodrive:frontend
            } || { echo "í”„ë¡ íŠ¸ì—”ë“œ ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨"; exit 1; }

  deployment:
    name: Deployment
    runs-on: ubuntu-22.04
    needs: prepare-release
    environment: production
    env:
      NODE_ENV: production
      APP_SERVER_PORT: 8000
      APP_CLIENT_PORT: 80
      APP_PUBLIC_HOST: cirrodrive.kro.kr
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      AUTH_JWT_SECRET: ${{ secrets.AUTH_JWT_SECRET }}
      AUTH_DEFAULT_ADMIN_USERNAME: ${{ secrets.AUTH_DEFAULT_ADMIN_USERNAME }}
      AUTH_DEFAULT_ADMIN_PASSWORD: ${{ secrets.AUTH_DEFAULT_ADMIN_PASSWORD }}
      AWS_REGION: ap-northeast-2
      AWS_SES_SOURCE_EMAIL: ${{ secrets.AWS_SES_SOURCE_EMAIL }}
      AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
      AWS_CLOUDFRONT_DOMAIN: ${{ secrets.AWS_CLOUDFRONT_DOMAIN }}
      AWS_CLOUDFRONT_KEY_PAIR_ID: ${{ secrets.AWS_CLOUDFRONT_KEY_PAIR_ID }}
      AWS_CLOUDFRONT_PRIVATE_KEY: ${{ secrets.AWS_CLOUDFRONT_PRIVATE_KEY }}
      AWS_CLOUDFRONT_EXPIRES_IN_SECONDS: 3600
      PAYMENT_TOSS_SECRET_KEY: ${{ secrets.PAYMENT_TOSS_SECRET_KEY }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            docker-compose.yml
          sparse-checkout-cone-mode: false
          fetch-depth: 1 # ìµœì í™”: ë¶ˆí•„ìš”í•œ Git íˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ì§€ ì•ŠìŒ

      - name: Copy Docker Compose file to server
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: "docker-compose.yml"
          target: "/home/${{ secrets.SERVER_USER }}/cirrodrive-deploy"
          overwrite: true

      - name: Deploy and Start Containers
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          envs: NODE_ENV,APP_SERVER_PORT,APP_CLIENT_PORT,APP_PUBLIC_HOST,DATABASE_URL,AUTH_JWT_SECRET,AUTH_DEFAULT_ADMIN_USERNAME,AUTH_DEFAULT_ADMIN_PASSWORD,AWS_REGION,AWS_SES_SOURCE_EMAIL,AWS_S3_BUCKET,AWS_CLOUDFRONT_DOMAIN,AWS_CLOUDFRONT_KEY_PAIR_ID,AWS_CLOUDFRONT_PRIVATE_KEY,AWS_CLOUDFRONT_EXPIRES_IN_SECONDS,PAYMENT_TOSS_SECRET_KEY
          script: |
            # ì‘ì—… ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd /home/${{ secrets.SERVER_USER }}/cirrodrive-deploy

            # Docker ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘
            docker-compose down
            docker-compose up -d || { echo "Docker ì»¨í…Œì´ë„ˆ ì‹œì‘ ì‹¤íŒ¨"; exit 1; }

  validate-deployment:
    name: Validate Deployment
    runs-on: ubuntu-22.04
    needs: deployment
    environment: production
    steps:
      - name: Wait for containers to initialize
        run: sleep 20

      - name: Check Container Health Status
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            echo "ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸ ì¤‘..."

            # ë°±ì—”ë“œ ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
            BACKEND_HEALTH=$(docker inspect --format='{{.State.Health.Status}}' cirrodrive-backend)
            echo "ë°±ì—”ë“œ ì»¨í…Œì´ë„ˆ ìƒíƒœ: $BACKEND_HEALTH"

            # í”„ë¡ íŠ¸ì—”ë“œ ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
            FRONTEND_HEALTH=$(docker inspect --format='{{.State.Health.Status}}' cirrodrive-frontend)
            echo "í”„ë¡ íŠ¸ì—”ë“œ ì»¨í…Œì´ë„ˆ ìƒíƒœ: $FRONTEND_HEALTH"

            # ìƒíƒœ ê²€ì¦
            if [ "$BACKEND_HEALTH" != "healthy" ] || [ "$FRONTEND_HEALTH" != "healthy" ]; then
              echo "ì»¨í…Œì´ë„ˆê°€ ì •ìƒ ìƒíƒœê°€ ì•„ë‹™ë‹ˆë‹¤!"
              
              if [ "$BACKEND_HEALTH" != "healthy" ]; then
                echo "ë°±ì—”ë“œ ì»¨í…Œì´ë„ˆ ë¡œê·¸:"
                docker logs cirrodrive-backend --tail 15
              fi
              
              if [ "$FRONTEND_HEALTH" != "healthy" ]; then
                echo "í”„ë¡ íŠ¸ì—”ë“œ ì»¨í…Œì´ë„ˆ ë¡œê·¸:"
                docker logs cirrodrive-frontend --tail 15
              fi
              
              exit 1
            fi

            echo "ëª¨ë“  ì»¨í…Œì´ë„ˆê°€ ì •ìƒ ìƒíƒœì…ë‹ˆë‹¤!"

            # ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ ë¡œê·¸ í™•ì¸
            docker ps -a | grep cirrodrive

  notify-success:
    name: Notify Success
    runs-on: ubuntu-22.04
    needs: validate-deployment
    env:
      APP_PUBLIC_HOST: cirrodrive.kro.kr
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Get commit info
        id: commit-info
        run: |
          echo "commit_sha=$(git log -1 --pretty=%h)" >> $GITHUB_OUTPUT

      - name: Get deployment details
        id: deployment-details
        run: |
          # í˜„ì¬ ì‹œê°„ (KST)
          NOW=$(TZ=Asia/Seoul date +"%Y-%m-%d %H:%M:%S %Z")
          echo "deployment_time=$NOW" >> $GITHUB_OUTPUT
          echo "workflow_url=https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_OUTPUT

      - name: Notify Discord Success
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          status: success
          title: "ğŸš€ ë°°í¬ ì„±ê³µ"
          description: |
            **í™˜ê²½:** Production
            **ë°°í¬ ì‹œê°„:** ${{ steps.deployment-details.outputs.deployment_time }}
            **URL:** http://${{ env.APP_PUBLIC_HOST }}
            **ì»¤ë°‹:** [${{ steps.commit-info.outputs.commit_sha }}](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})
          color: 3066993
          url: ${{ steps.deployment-details.outputs.workflow_url }}
          username: GitHub Actions
          avatar_url: https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png

  notify-failure:
    name: Notify Failure
    runs-on: ubuntu-22.04
    needs: validate-deployment
    if: failure()
    env:
      APP_PUBLIC_HOST: cirrodrive.kro.kr
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Get commit info
        id: commit-info
        run: |
          echo "commit_sha=$(git log -1 --pretty=%h)" >> $GITHUB_OUTPUT

      - name: Get deployment details
        id: deployment-details
        run: |
          # í˜„ì¬ ì‹œê°„ (KST)
          NOW=$(TZ=Asia/Seoul date +"%Y-%m-%d %H:%M:%S %Z")
          echo "deployment_time=$NOW" >> $GITHUB_OUTPUT
          echo "workflow_url=https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_OUTPUT

      - name: Notify Discord Failure
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          status: failure
          content: "@here ë°°í¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤! ê¸´ê¸‰ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤."
          title: "âŒ ë°°í¬ ì‹¤íŒ¨"
          description: |
            **í™˜ê²½:** Production
            **ë°°í¬ ì‹œê°„:** ${{ steps.deployment-details.outputs.deployment_time }}
            **URL:** http://${{ env.APP_PUBLIC_HOST }}
            **ì»¤ë°‹:** [${{ steps.commit-info.outputs.commit_sha }}](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})
          color: 15158332
          url: ${{ steps.deployment-details.outputs.workflow_url }}
          username: GitHub Actions
          avatar_url: https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png
